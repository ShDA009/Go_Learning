# –ì–æ–Ω–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –µ—ë –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ (Data Race)

## üí° –ö–ª—é—á–µ–≤—ã–µ –∏–¥–µ–∏

1. **–ì–æ–Ω–∫–∞ –¥–∞–Ω–Ω—ã—Ö** ‚Äî –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –ø–∞–º—è—Ç–∏ –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≥–æ—Ä—É—Ç–∏–Ω (–º–∏–Ω–∏–º—É–º –æ–¥–Ω–∞ –ø–∏—à–µ—Ç)
2. **–ù–µ–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å** ‚Äî —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –ø–æ—Ä—è–¥–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
3. **Race Detector** ‚Äî –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç Go –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –≥–æ–Ω–æ–∫
4. **–§–ª–∞–≥ `-race`** ‚Äî –≤–∫–ª—é—á–∞–µ—Ç –¥–µ—Ç–µ–∫—Ç–æ—Ä –ø—Ä–∏ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏/–∑–∞–ø—É—Å–∫–µ
5. **–†–µ—à–µ–Ω–∏—è** ‚Äî –º—å—é—Ç–µ–∫—Å—ã, –∫–∞–Ω–∞–ª—ã, –∞—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

---

## üìã –°–∏–Ω—Ç–∞–∫—Å–∏—Å

### –ó–∞–ø—É—Å–∫ —Å Race Detector

```bash
# –ó–∞–ø—É—Å–∫ —Å –¥–µ—Ç–µ–∫—Ç–æ—Ä–æ–º
go run -race main.go

# –°–±–æ—Ä–∫–∞ —Å –¥–µ—Ç–µ–∫—Ç–æ—Ä–æ–º
go build -race -o program main.go

# –¢–µ—Å—Ç—ã —Å –¥–µ—Ç–µ–∫—Ç–æ—Ä–æ–º
go test -race ./...
```

### Race Detector –≤—ã–≤–æ–¥–∏—Ç

```
WARNING: DATA RACE
Read at 0x... by goroutine X:
  main.function()
      /path/file.go:LINE

Previous write at 0x... by goroutine Y:
  main.function()
      /path/file.go:LINE
```

---

## üíª –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞

### –ü—Ä–∏–º–µ—Ä –≥–æ–Ω–∫–∏ –¥–∞–Ω–Ω—ã—Ö

```go
package main

import (
    "fmt"
    "sync"
)

var counter int  // –æ–±—â–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è

func increment(wg *sync.WaitGroup) {
    defer wg.Done()
    
    for i := 0; i < 1000; i++ {
        counter++  // ‚ùå –ì–æ–Ω–∫–∞! –ß—Ç–µ–Ω–∏–µ –∏ –∑–∞–ø–∏—Å—å –±–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
    }
}

func main() {
    var wg sync.WaitGroup
    
    wg.Add(2)
    go increment(&wg)
    go increment(&wg)
    
    wg.Wait()
    
    // –û–∂–∏–¥–∞–µ–º 2000, –Ω–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º!
    fmt.Println("Counter:", counter)
}
```

### –ó–∞–ø—É—Å–∫ —Å Race Detector

```bash
$ go run -race main.go
==================
WARNING: DATA RACE
Read at 0x00c0000140a8 by goroutine 8:
  main.increment()
      /main.go:12 +0x50

Previous write at 0x00c0000140a8 by goroutine 7:
  main.increment()
      /main.go:12 +0x64

Goroutine 8 (running) created at:
  main.main()
      /main.go:20 +0x90

Goroutine 7 (running) created at:
  main.main()
      /main.go:19 +0x70
==================
Counter: 1847
Found 1 data race(s)
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: sync.Mutex

```go
package main

import (
    "fmt"
    "sync"
)

var (
    counter int
    mutex   sync.Mutex
)

func increment(wg *sync.WaitGroup) {
    defer wg.Done()
    
    for i := 0; i < 1000; i++ {
        mutex.Lock()
        counter++  // ‚úÖ –ó–∞—â–∏—â–µ–Ω–æ –º—å—é—Ç–µ–∫—Å–æ–º
        mutex.Unlock()
    }
}

func main() {
    var wg sync.WaitGroup
    
    wg.Add(2)
    go increment(&wg)
    go increment(&wg)
    
    wg.Wait()
    
    fmt.Println("Counter:", counter)  // –í—Å–µ–≥–¥–∞ 2000
}
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: sync/atomic

```go
package main

import (
    "fmt"
    "sync"
    "sync/atomic"
)

var counter int64  // atomic —Ç—Ä–µ–±—É–µ—Ç int32/int64

func increment(wg *sync.WaitGroup) {
    defer wg.Done()
    
    for i := 0; i < 1000; i++ {
        atomic.AddInt64(&counter, 1)  // ‚úÖ –ê—Ç–æ–º–∞—Ä–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
    }
}

func main() {
    var wg sync.WaitGroup
    
    wg.Add(2)
    go increment(&wg)
    go increment(&wg)
    
    wg.Wait()
    
    fmt.Println("Counter:", atomic.LoadInt64(&counter))  // –í—Å–µ–≥–¥–∞ 2000
}
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: –ö–∞–Ω–∞–ª—ã

```go
package main

import "fmt"

func increment(ch chan int, n int) {
    for i := 0; i < n; i++ {
        ch <- 1  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–¥–∏–Ω–∏—Ü—É
    }
}

func main() {
    ch := make(chan int)
    
    go increment(ch, 1000)
    go increment(ch, 1000)
    
    counter := 0
    for i := 0; i < 2000; i++ {
        counter += <-ch  // –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –ø–æ–ª—É—á–∞—Ç–µ–ª—å
    }
    
    fmt.Println("Counter:", counter)  // –í—Å–µ–≥–¥–∞ 2000
}
```

### –ì–æ–Ω–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –∏ –∑–∞–ø–∏—Å–∏ map

```go
package main

import (
    "fmt"
    "sync"
)

func main() {
    m := make(map[string]int)
    var wg sync.WaitGroup
    
    // ‚ùå –ì–æ–Ω–∫–∞ –¥–∞–Ω–Ω—ã—Ö!
    wg.Add(2)
    go func() {
        defer wg.Done()
        for i := 0; i < 1000; i++ {
            m["key"] = i  // –ó–∞–ø–∏—Å—å
        }
    }()
    go func() {
        defer wg.Done()
        for i := 0; i < 1000; i++ {
            _ = m["key"]  // –ß—Ç–µ–Ω–∏–µ
        }
    }()
    
    wg.Wait()
    fmt.Println(m["key"])
}
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: sync.Map

```go
package main

import (
    "fmt"
    "sync"
)

func main() {
    var m sync.Map  // ‚úÖ –ü–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π map
    var wg sync.WaitGroup
    
    wg.Add(2)
    go func() {
        defer wg.Done()
        for i := 0; i < 1000; i++ {
            m.Store("key", i)
        }
    }()
    go func() {
        defer wg.Done()
        for i := 0; i < 1000; i++ {
            m.Load("key")
        }
    }()
    
    wg.Wait()
    val, _ := m.Load("key")
    fmt.Println(val)
}
```

### –ì–æ–Ω–∫–∞ –≤ –ø—Ä–æ–≤–µ—Ä–∫–µ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏

```go
package main

import (
    "fmt"
    "sync"
    "time"
)

var value = 100

func checkAndUpdate(id int, wg *sync.WaitGroup) {
    defer wg.Done()
    
    // ‚ùå TOCTOU race (Time Of Check To Time Of Use)
    if value == 100 {
        time.Sleep(10 * time.Millisecond)
        value = id  // –î—Ä—É–≥–∞—è –≥–æ—Ä—É—Ç–∏–Ω–∞ –º–æ–≥–ª–∞ –∏–∑–º–µ–Ω–∏—Ç—å!
        fmt.Printf("Goroutine %d updated value to %d\n", id, id)
    }
}

func main() {
    var wg sync.WaitGroup
    
    wg.Add(3)
    go checkAndUpdate(1, &wg)
    go checkAndUpdate(2, &wg)
    go checkAndUpdate(3, &wg)
    
    wg.Wait()
    fmt.Println("Final value:", value)
}
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ TOCTOU

```go
package main

import (
    "fmt"
    "sync"
    "time"
)

var (
    value = 100
    mu    sync.Mutex
)

func checkAndUpdate(id int, wg *sync.WaitGroup) {
    defer wg.Done()
    
    mu.Lock()
    defer mu.Unlock()
    
    // ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∞—Ç–æ–º–∞—Ä–Ω—ã
    if value == 100 {
        time.Sleep(10 * time.Millisecond)
        value = id
        fmt.Printf("Goroutine %d updated value to %d\n", id, id)
    }
}

func main() {
    var wg sync.WaitGroup
    
    wg.Add(3)
    go checkAndUpdate(1, &wg)
    go checkAndUpdate(2, &wg)
    go checkAndUpdate(3, &wg)
    
    wg.Wait()
    fmt.Println("Final value:", value)
}
```

### –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–º–µ—Ä: –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å—á—ë—Ç—á–∏–∫

```go
package main

import (
    "fmt"
    "sync"
)

type SafeCounter struct {
    mu    sync.Mutex
    value int
}

func (c *SafeCounter) Increment() {
    c.mu.Lock()
    defer c.mu.Unlock()
    c.value++
}

func (c *SafeCounter) Decrement() {
    c.mu.Lock()
    defer c.mu.Unlock()
    c.value--
}

func (c *SafeCounter) Value() int {
    c.mu.Lock()
    defer c.mu.Unlock()
    return c.value
}

func main() {
    counter := &SafeCounter{}
    var wg sync.WaitGroup
    
    // 100 –≥–æ—Ä—É—Ç–∏–Ω –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∏—Ä—É—é—Ç
    for i := 0; i < 100; i++ {
        wg.Add(1)
        go func() {
            defer wg.Done()
            for j := 0; j < 100; j++ {
                counter.Increment()
            }
        }()
    }
    
    wg.Wait()
    fmt.Println("Final value:", counter.Value())  // 10000
}
```

---

## ‚ö†Ô∏è –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

### 1. –ß—Ç–µ–Ω–∏–µ –±–µ–∑ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

```go
// ‚ùå –ß—Ç–µ–Ω–∏–µ —Ç–æ–∂–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ!
func getValue() int {
    return counter  // –ì–æ–Ω–∫–∞, –µ—Å–ª–∏ –¥—Ä—É–≥–∞—è –≥–æ—Ä—É—Ç–∏–Ω–∞ –ø–∏—à–µ—Ç
}

// ‚úÖ –ó–∞—â–∏—â–∞–µ–º —á—Ç–µ–Ω–∏–µ
func getValue() int {
    mu.Lock()
    defer mu.Unlock()
    return counter
}
```

### 2. –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–∞–Ω–∞–ª–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –≥–æ—Ä—É—Ç–∏–Ω–∞–º–∏

```go
// ‚ùå –ì–æ–Ω–∫–∞ ‚Äî –∫—Ç–æ –ø–µ—Ä–≤—ã–π –∑–∞–∫—Ä–æ–µ—Ç?
go func() { close(ch) }()
go func() { close(ch) }()

// ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ sync.Once
var once sync.Once
go func() { once.Do(func() { close(ch) }) }()
go func() { once.Do(func() { close(ch) }) }()
```

### 3. Race detector –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç –≤—Å–µ –≥–æ–Ω–∫–∏

```go
// ‚ö†Ô∏è Race detector —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ runtime
// –ì–æ–Ω–∫–∞ –ø—Ä–æ—è–≤–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≥–æ—Ä—É—Ç–∏–Ω—ã –≤—ã–ø–æ–ª–Ω—è—Ç—Å—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
// –ó–∞–ø—É—Å–∫–∞–π—Ç–µ —Ç–µ—Å—Ç—ã –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ: go test -race -count=100
```

### 4. –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π race detector

```go
// ‚ùå "–†–∞–±–æ—Ç–∞–µ—Ç –∂–µ!"
// Race detector –Ω–∞—à—ë–ª –≥–æ–Ω–∫—É ‚Äî —ç—Ç–æ –æ—à–∏–±–∫–∞, –∫–æ—Ç–æ—Ä—É—é –ù–£–ñ–ù–û –∏—Å–ø—Ä–∞–≤–∏—Ç—å
// –î–∞–∂–µ –µ—Å–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞ "—Ä–∞–±–æ—Ç–∞–µ—Ç", —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ–¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω
```

---

## üìù –ü—Ä–∞–∫—Ç–∏–∫–∞

### –ó–∞–¥–∞—á–∞ 1: –ù–∞–π–¥–∏ –≥–æ–Ω–∫—É
–ù–∞–π–¥–∏—Ç–µ –∏ –∏—Å–ø—Ä–∞–≤—å—Ç–µ –≥–æ–Ω–∫—É –¥–∞–Ω–Ω—ã—Ö –≤ –∑–∞–¥–∞–Ω–Ω–æ–º –∫–æ–¥–µ.

### –ó–∞–¥–∞—á–∞ 2: –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π map
–†–µ–∞–ª–∏–∑—É–π—Ç–µ –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—É—é –æ–±—ë—Ä—Ç–∫—É –Ω–∞–¥ map —Å –º–µ—Ç–æ–¥–∞–º–∏ Get, Set, Delete.

### –ó–∞–¥–∞—á–∞ 3: –°—á—ë—Ç—á–∏–∫ –ø–æ—Å–µ—â–µ–Ω–∏–π
–°–æ–∑–¥–∞–π—Ç–µ –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Å—á—ë—Ç—á–∏–∫ –ø–æ—Å–µ—â–µ–Ω–∏–π —Å—Ç—Ä–∞–Ω–∏—Ü (map[string]int).

### –ó–∞–¥–∞—á–∞ 4: Lazy initialization
–†–µ–∞–ª–∏–∑—É–π—Ç–µ –±–µ–∑–æ–ø–∞—Å–Ω—É—é –ª–µ–Ω–∏–≤—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é —Å sync.Once.

### –ó–∞–¥–∞—á–∞ 5: Read-Write Lock
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ sync.RWMutex –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —á–∞—Å—Ç—ã—Ö —á—Ç–µ–Ω–∏–π.

### –ó–∞–¥–∞—á–∞ 6: Atomic flag
–†–µ–∞–ª–∏–∑—É–π—Ç–µ –∞—Ç–æ–º–∞—Ä–Ω—ã–π —Ñ–ª–∞–≥ Started/Stopped.

### –ó–∞–¥–∞—á–∞ 7: Connection pool
–°–æ–∑–¥–∞–π—Ç–µ –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π.

### –ó–∞–¥–∞—á–∞ 8: Rate limiter
–†–µ–∞–ª–∏–∑—É–π—Ç–µ –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π rate limiter —Å –∞—Ç–æ–º–∞—Ä–Ω—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏.
