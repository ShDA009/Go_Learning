# –†–∞–±–æ—Ç–∞ —Å —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã–º–∏ –±–∞–∑–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö (database/sql)

## üí° –ö–ª—é—á–µ–≤—ã–µ –∏–¥–µ–∏

1. **database/sql** ‚Äî —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–∞–∫–µ—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å SQL –ë–î
2. **–î—Ä–∞–π–≤–µ—Ä—ã** ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –∫–∞–∂–¥–æ–π –°–£–ë–î
3. **sql.Open** ‚Äî –æ—Ç–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –ë–î
4. **sql.DB** ‚Äî –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (connection pool)
5. **Exec, Query, QueryRow** ‚Äî –æ—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤

---

## üìã –°–∏–Ω—Ç–∞–∫—Å–∏—Å

### –û—Ç–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

```go
db, err := sql.Open(driverName, dataSourceName)
defer db.Close()
```

### –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã sql.DB

```go
// –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –±–µ–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (INSERT, UPDATE, DELETE)
db.Exec(query string, args ...interface{}) (Result, error)

// –ó–∞–ø—Ä–æ—Å —Å –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º —Å—Ç—Ä–æ–∫ (SELECT)
db.Query(query string, args ...interface{}) (*Rows, error)

// –ó–∞–ø—Ä–æ—Å —Å –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–æ–π
db.QueryRow(query string, args ...interface{}) *Row

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
db.Ping() error

// –ó–∞–∫—Ä—ã—Ç–∏–µ
db.Close() error
```

### –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å Result

```go
type Result interface {
    LastInsertId() (int64, error)  // ID –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤—Å—Ç–∞–≤–∫–∏
    RowsAffected() (int64, error)  // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö —Å—Ç—Ä–æ–∫
}
```

### –†–∞–±–æ—Ç–∞ —Å Rows

```go
rows.Next() bool               // –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–æ–∫–µ
rows.Scan(dest ...interface{}) // —á—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
rows.Close() error             // –∑–∞–∫—Ä—ã—Ç–∏–µ
rows.Columns() ([]string, error)  // –∏–º–µ–Ω–∞ —Å—Ç–æ–ª–±—Ü–æ–≤
rows.Err() error               // –æ—à–∏–±–∫–∞ –∏—Ç–µ—Ä–∞—Ü–∏–∏
```

---

## üíª –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

```go
package main

import (
    "database/sql"
    "fmt"
    "log"
    
    _ "github.com/go-sql-driver/mysql"  // MySQL –¥—Ä–∞–π–≤–µ—Ä
)

func main() {
    // –§–æ—Ä–º–∞—Ç: user:password@tcp(host:port)/dbname
    dsn := "root:password@tcp(localhost:3306)/mydb"
    
    db, err := sql.Open("mysql", dsn)
    if err != nil {
        log.Fatal("Open error:", err)
    }
    defer db.Close()
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
    err = db.Ping()
    if err != nil {
        log.Fatal("Ping error:", err)
    }
    
    fmt.Println("Connected to database!")
}
```

### –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã

```go
package main

import (
    "database/sql"
    "fmt"
    "log"
    
    _ "github.com/go-sql-driver/mysql"
)

func main() {
    db, err := sql.Open("mysql", "root:password@tcp(localhost:3306)/mydb")
    if err != nil {
        log.Fatal(err)
    }
    defer db.Close()
    
    // –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É
    query := `
        CREATE TABLE IF NOT EXISTS products (
            id INT AUTO_INCREMENT PRIMARY KEY,
            name VARCHAR(100) NOT NULL,
            price DECIMAL(10,2) NOT NULL,
            quantity INT DEFAULT 0
        )
    `
    
    _, err = db.Exec(query)
    if err != nil {
        log.Fatal("Create table error:", err)
    }
    
    fmt.Println("Table created!")
}
```

### INSERT ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

```go
package main

import (
    "database/sql"
    "fmt"
    "log"
    
    _ "github.com/go-sql-driver/mysql"
)

func main() {
    db, _ := sql.Open("mysql", "root:password@tcp(localhost:3306)/mydb")
    defer db.Close()
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ (–∑–∞—â–∏—Ç–∞ –æ—Ç SQL injection)
    result, err := db.Exec(
        "INSERT INTO products (name, price, quantity) VALUES (?, ?, ?)",
        "iPhone 15", 999.99, 100,
    )
    if err != nil {
        log.Fatal(err)
    }
    
    // –ü–æ–ª—É—á–∞–µ–º ID –≤—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –∑–∞–ø–∏—Å–∏
    lastID, _ := result.LastInsertId()
    fmt.Println("Inserted ID:", lastID)
    
    // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö —Å—Ç—Ä–æ–∫
    rows, _ := result.RowsAffected()
    fmt.Println("Rows affected:", rows)
}
```

### SELECT ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

```go
package main

import (
    "database/sql"
    "fmt"
    "log"
    
    _ "github.com/go-sql-driver/mysql"
)

type Product struct {
    ID       int
    Name     string
    Price    float64
    Quantity int
}

func main() {
    db, _ := sql.Open("mysql", "root:password@tcp(localhost:3306)/mydb")
    defer db.Close()
    
    // –ó–∞–ø—Ä–æ—Å –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π
    rows, err := db.Query("SELECT id, name, price, quantity FROM products")
    if err != nil {
        log.Fatal(err)
    }
    defer rows.Close()
    
    var products []Product
    
    for rows.Next() {
        var p Product
        err := rows.Scan(&p.ID, &p.Name, &p.Price, &p.Quantity)
        if err != nil {
            log.Println("Scan error:", err)
            continue
        }
        products = append(products, p)
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—à–∏–±–∫–∏ –∏—Ç–µ—Ä–∞—Ü–∏–∏
    if err = rows.Err(); err != nil {
        log.Fatal(err)
    }
    
    // –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    for _, p := range products {
        fmt.Printf("%d: %s - $%.2f (qty: %d)\n", 
            p.ID, p.Name, p.Price, p.Quantity)
    }
}
```

### QueryRow ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏

```go
package main

import (
    "database/sql"
    "fmt"
    "log"
    
    _ "github.com/go-sql-driver/mysql"
)

type Product struct {
    ID       int
    Name     string
    Price    float64
    Quantity int
}

func main() {
    db, _ := sql.Open("mysql", "root:password@tcp(localhost:3306)/mydb")
    defer db.Close()
    
    var p Product
    
    err := db.QueryRow(
        "SELECT id, name, price, quantity FROM products WHERE id = ?", 1,
    ).Scan(&p.ID, &p.Name, &p.Price, &p.Quantity)
    
    if err == sql.ErrNoRows {
        fmt.Println("Product not found")
        return
    }
    if err != nil {
        log.Fatal(err)
    }
    
    fmt.Printf("Product: %+v\n", p)
}
```

### UPDATE ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

```go
package main

import (
    "database/sql"
    "fmt"
    "log"
    
    _ "github.com/go-sql-driver/mysql"
)

func main() {
    db, _ := sql.Open("mysql", "root:password@tcp(localhost:3306)/mydb")
    defer db.Close()
    
    result, err := db.Exec(
        "UPDATE products SET price = ?, quantity = ? WHERE id = ?",
        899.99, 150, 1,
    )
    if err != nil {
        log.Fatal(err)
    }
    
    rows, _ := result.RowsAffected()
    fmt.Printf("Updated %d rows\n", rows)
}
```

### DELETE ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ

```go
package main

import (
    "database/sql"
    "fmt"
    "log"
    
    _ "github.com/go-sql-driver/mysql"
)

func main() {
    db, _ := sql.Open("mysql", "root:password@tcp(localhost:3306)/mydb")
    defer db.Close()
    
    result, err := db.Exec("DELETE FROM products WHERE id = ?", 5)
    if err != nil {
        log.Fatal(err)
    }
    
    rows, _ := result.RowsAffected()
    fmt.Printf("Deleted %d rows\n", rows)
}
```

### Prepared Statements

```go
package main

import (
    "database/sql"
    "fmt"
    "log"
    
    _ "github.com/go-sql-driver/mysql"
)

func main() {
    db, _ := sql.Open("mysql", "root:password@tcp(localhost:3306)/mydb")
    defer db.Close()
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø—Ä–æ—Å
    stmt, err := db.Prepare("INSERT INTO products (name, price) VALUES (?, ?)")
    if err != nil {
        log.Fatal(err)
    }
    defer stmt.Close()
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ
    products := []struct {
        Name  string
        Price float64
    }{
        {"MacBook Pro", 2499.99},
        {"iPad Pro", 1099.99},
        {"AirPods", 249.99},
    }
    
    for _, p := range products {
        result, err := stmt.Exec(p.Name, p.Price)
        if err != nil {
            log.Println("Insert error:", err)
            continue
        }
        id, _ := result.LastInsertId()
        fmt.Printf("Inserted %s with ID %d\n", p.Name, id)
    }
}
```

### –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

```go
package main

import (
    "database/sql"
    "fmt"
    "log"
    
    _ "github.com/go-sql-driver/mysql"
)

func main() {
    db, _ := sql.Open("mysql", "root:password@tcp(localhost:3306)/mydb")
    defer db.Close()
    
    // –ù–∞—á–∏–Ω–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
    tx, err := db.Begin()
    if err != nil {
        log.Fatal(err)
    }
    
    // –í—ã–ø–æ–ª–Ω—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏–∏
    _, err = tx.Exec("UPDATE accounts SET balance = balance - 100 WHERE id = 1")
    if err != nil {
        tx.Rollback()
        log.Fatal("Debit failed:", err)
    }
    
    _, err = tx.Exec("UPDATE accounts SET balance = balance + 100 WHERE id = 2")
    if err != nil {
        tx.Rollback()
        log.Fatal("Credit failed:", err)
    }
    
    // –§–∏–∫—Å–∏—Ä—É–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
    err = tx.Commit()
    if err != nil {
        log.Fatal("Commit failed:", err)
    }
    
    fmt.Println("Transaction completed!")
}
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

```go
package main

import (
    "database/sql"
    "time"
    
    _ "github.com/go-sql-driver/mysql"
)

func main() {
    db, _ := sql.Open("mysql", "root:password@tcp(localhost:3306)/mydb")
    defer db.Close()
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—É–ª–∞
    db.SetMaxOpenConns(25)                  // –º–∞–∫—Å. –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
    db.SetMaxIdleConns(5)                   // –º–∞–∫—Å. idle —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
    db.SetConnMaxLifetime(5 * time.Minute)  // –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    db.SetConnMaxIdleTime(1 * time.Minute)  // –º–∞–∫—Å. –≤—Ä–µ–º—è idle
}
```

---

## ‚ö†Ô∏è –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

### 1. –ù–µ –∑–∞–∫—Ä—ã–≤–∞—é—Ç rows

```go
// ‚ùå –£—Ç–µ—á–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π!
rows, _ := db.Query("SELECT * FROM products")
for rows.Next() {
    // ...
}
// rows –Ω–µ –∑–∞–∫—Ä—ã—Ç!

// ‚úÖ –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ defer
rows, err := db.Query("SELECT * FROM products")
if err != nil {
    return err
}
defer rows.Close()
```

### 2. –ù–µ –ø—Ä–æ–≤–µ—Ä—è—é—Ç rows.Err()

```go
// ‚ùå –û—à–∏–±–∫–∞ –∏—Ç–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Ä—è–µ—Ç—Å—è
for rows.Next() {
    rows.Scan(&data)
}

// ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ø–æ—Å–ª–µ —Ü–∏–∫–ª–∞
for rows.Next() {
    rows.Scan(&data)
}
if err := rows.Err(); err != nil {
    log.Fatal(err)
}
```

### 3. SQL Injection

```go
// ‚ùå –û–ü–ê–°–ù–û!
name := "'; DROP TABLE products; --"
db.Query("SELECT * FROM products WHERE name = '" + name + "'")

// ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
db.Query("SELECT * FROM products WHERE name = ?", name)
```

### 4. –ù–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç sql.ErrNoRows

```go
// ‚ùå –ù–µ —Ä–∞–∑–ª–∏—á–∞—é—Ç "–Ω–µ –Ω–∞–π–¥–µ–Ω–æ" –∏ –æ—à–∏–±–∫—É
err := db.QueryRow(...).Scan(...)
if err != nil {
    log.Fatal(err)  // –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–æ—Å—Ç–æ –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
}

// ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ ErrNoRows
if err == sql.ErrNoRows {
    // –∑–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ
} else if err != nil {
    log.Fatal(err)  // —Ä–µ–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞
}
```

---

## üìù –ü—Ä–∞–∫—Ç–∏–∫–∞

### –ó–∞–¥–∞—á–∞ 1: CRUD —Å–µ—Ä–≤–∏—Å
–°–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª–Ω—ã–π CRUD –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

### –ó–∞–¥–∞—á–∞ 2: Repository pattern
–†–µ–∞–ª–∏–∑—É–π—Ç–µ –ø–∞—Ç—Ç–µ—Ä–Ω Repository –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î.

### –ó–∞–¥–∞—á–∞ 3: –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –ø–µ—Ä–µ–≤–æ–¥–∞
–†–µ–∞–ª–∏–∑—É–π—Ç–µ –ø–µ—Ä–µ–≤–æ–¥ –¥–µ–Ω–µ–≥ –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏.

### –ó–∞–¥–∞—á–∞ 4: –ú–∏–≥—Ä–∞—Ü–∏–∏
–°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Å—Ç—É—é —Å–∏—Å—Ç–µ–º—É –º–∏–≥—Ä–∞—Ü–∏–π –ë–î.

### –ó–∞–¥–∞—á–∞ 5: Connection pool
–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π.

### –ó–∞–¥–∞—á–∞ 6: Bulk insert
–†–µ–∞–ª–∏–∑—É–π—Ç–µ –º–∞—Å—Å–æ–≤—É—é –≤—Å—Ç–∞–≤–∫—É –¥–∞–Ω–Ω—ã—Ö.

### –ó–∞–¥–∞—á–∞ 7: Query builder
–°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Å—Ç–æ–π –ø–æ—Å—Ç—Ä–æ–∏—Ç–µ–ª—å SQL –∑–∞–ø—Ä–æ—Å–æ–≤.

### –ó–∞–¥–∞—á–∞ 8: ORM-lite
–°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Å—Ç–æ–π –º–∞–ø–ø–∏–Ω–≥ —Å—Ç—Ä—É–∫—Ç—É—Ä –Ω–∞ —Ç–∞–±–ª–∏—Ü—ã.
